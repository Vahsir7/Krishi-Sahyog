{% extends "base.html" %}
{% block title %}Crop Selection{% endblock %}
{% block content %}
<div class="card p-4">
  <h3 class="mb-4">ðŸŒ¾ Crop Suggestion</h3>
  <p>Enter the field conditions to get a crop suggestion based on sustainability and yield.</p>
  {# --- Keep your form as is --- #}
  <form id="crop-suggestion-form" method="post" action="/suggest_crop"> 
    <div class="row g-3">
      <div class="col-md-6 mb-3">
        <label for="soil_ph" class="form-label">Soil pH:</label>
        <input type="number" step="0.1" class="form-control" id="soil_ph" name="soil_ph" placeholder="e.g., 6.5" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="soil_moisture" class="form-label">Soil Moisture (%):</label>
        <input type="number" step="1" class="form-control" id="soil_moisture" name="soil_moisture" placeholder="e.g., 40" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="temperature" class="form-label">Temperature (Â°C):</label>
        <input type="number" step="1" class="form-control" id="temperature" name="temperature" placeholder="e.g., 25" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="rainfall" class="form-label">Rainfall (mm):</label>
        <input type="number" step="1" class="form-control" id="rainfall" name="rainfall" placeholder="e.g., 150" required>
      </div>
    </div>
    <button type="submit" class="btn btn-info mt-3">Suggest Crop</button>
  </form>

  {# --- Updated Results Section --- #}
  {% if suggestion %} {# Check if suggestion dictionary exists #}
  <div class="mt-4 response-box">
    <strong>Suggestion based on your input:</strong><br>
    <ul class="list-unstyled">
        <li><strong>Input Conditions:</strong> pH={{ suggestion.input.Soil_pH }}, Moisture={{ suggestion.input.Soil_Moisture }}%, Temp={{ suggestion.input.Temperature_C }}Â°C, Rainfall={{ suggestion.input.Rainfall_mm }}mm</li>

        {# --- Case 1: Found a good sustainable match --- #}
        {% if suggestion.found_sustainable %}
            <li><strong>Sustainable Suggestion:</strong> {{ suggestion.sustainable_crop.Crop_Type | default('N/A') }}</li>
            <li><strong>Est. Fertilizer:</strong> {{ suggestion.sustainable_crop.Fertilizer_Usage_kg | default('N/A') }} kg/ha</li>
            <li><strong>Est. Pesticide:</strong> {{ suggestion.sustainable_crop.Pesticide_Usage_kg | default('N/A') }} kg/ha</li>
            <li><strong>Est. Yield:</strong> {{ suggestion.sustainable_crop.Crop_Yield_ton | default('N/A') }} tons/ha</li>
            <li><strong>Sustainability Score:</strong> {{ suggestion.sustainable_crop.Sustainability_Score | default('N/A') }}</li>

        {# --- Case 2: No good sustainable match, but found alternative --- #}
        {% elif suggestion.found_alternative %}
            <li><strong class="text-warning">No highly sustainable crop found matching closely.</strong></li>
            <li><strong>Alternative for Higher Yield:</strong> {{ suggestion.alternative_yield_crop.Crop_Type | default('N/A') }}</li>
            <li><strong>Est. Yield:</strong> {{ suggestion.alternative_yield_crop.Crop_Yield_ton | default('N/A') }} tons/ha</li>
            <li><em>(Sustainability Score: {{ suggestion.alternative_yield_crop.Sustainability_Score | default('N/A') }})</em></li>
            {% if suggestion.condition_changes %}
            <li><strong>To optimize for this crop, consider adjusting:</strong>
                <ul class="list-unstyled ms-3">
                    {% for condition, change in suggestion.condition_changes.items() %}
                        {% if change != 0 %} {# Only show actual changes needed #}
                            <li>
                                {% if condition == 'Soil_pH' %} Soil pH by {{ change }}
                                {% elif condition == 'Soil_Moisture' %} Soil Moisture by {{ change }}%
                                {% elif condition == 'Temperature_C' %} Temperature by {{ change }}Â°C
                                {% elif condition == 'Rainfall_mm' %} Rainfall/Irrigation by {{ change }}mm
                                {% endif %}
                                (Target: {{ suggestion.alternative_yield_crop[condition] }})
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </li>
            {% endif %}

        {# --- Case 3: No matches found at all (unlikely with NN) --- #}
        {% else %}
            <li><strong class="text-danger">Could not find any relevant crop data in the dataset for conditions near your input.</strong></li>
        {% endif %}
    </ul>
    {# --- Optional: Add Ollama summary if you integrate it --- #}
    {# {% if suggestion.ollama_summary %} ... {% endif %} #}
  </div>
  {% endif %} {# End suggestion exists check #}
</div>
{% endblock %}
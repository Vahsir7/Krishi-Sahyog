{% extends "base.html" %}
{% block title %}KrishiSahyog Chat{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-7">
    <div class="card chat-card shadow-sm">
      <div class="card-header bg-success text-white text-center">
        <h5 class="mb-0">
          <span class="me-2">ðŸŒ¾</span> KrishiSahyog
        </h5>
        <small class="opacity-75">Your Multilingual Farming Assistant</small>
      </div>

      <div class="card-body p-0">
        <!-- Chat area -->
        <div class="chat-box" id="chat-box" aria-live="polite">
          <div class="chat-message bot-message">
            Hello! I'm KrishiSahyog. Ask me any questions about farming in any Indian language.
          </div>
        </div>
      </div>

      <div class="card-footer">
        <!-- Input area -->
        <form class="chat-input d-flex gap-2" id="chat-form" autocomplete="off">
          <input type="text" id="message" name="message" class="form-control"
                 placeholder="Type your message..." autocomplete="off" required>
          <button type="submit" class="btn btn-success d-flex align-items-center justify-content-center px-3"
                  aria-label="Send">
            <i class="bi bi-send-fill"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  /* Scope everything under .chat-card to avoid bleeding into other pages */
  .chat-card .chat-box{
    height: 60vh;
    overflow-y: auto;
    padding: 1rem;
    background: var(--bs-body-bg);
  }
  .chat-card .chat-message{
    padding: .6rem 1rem;
    border-radius: 1rem;
    max-width: 80%;
    line-height: 1.5;
    box-shadow: 0 2px 6px rgba(0,0,0,.06);
    margin: .4rem 0;
  }
  .chat-card .user-message{
    background: var(--bs-primary);
    color: #fff;
    margin-left: auto;
  }
  .chat-card .bot-message{
    background: var(--bs-tertiary-bg);
    color: var(--bs-body-color);
    margin-right: auto;
  }
  .chat-card .loading{
    display: flex;
    gap: .5rem;
    align-items: center;
    font-style: italic;
    opacity: .9;
  }
</style>
{% endblock %}

{% block scripts %}
<!-- Your script kept exactly as provided -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('message');

        const addMessage = (message, sender) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', `${sender}-message`);
            messageElement.textContent = message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        const showLoadingIndicator = () => {
            const loadingElement = document.createElement('div');
            loadingElement.classList.add('chat-message', 'bot-message', 'loading');
            loadingElement.id = 'loading-indicator';
            loadingElement.innerHTML = `<div class="spinner-grow spinner-grow-sm" role="status"><span class="visually-hidden">Loading...</span></div><span>AgriBot is typing...</span>`;
            chatBox.appendChild(loadingElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        const hideLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();

            if (userMessage) {
                addMessage(userMessage, 'user');
                userInput.value = '';
                showLoadingIndicator();

                try {
                    const formData = new FormData();
                    formData.append('message', userMessage);
                    
                    const response = await fetch('/multilingual_chat', {
                        method: 'POST',
                        body: formData,
                    });

                    hideLoadingIndicator();
                    
                    const responseText = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('Failed to parse JSON:', responseText);
                        addMessage('Server returned invalid response format. Check server logs.', 'bot');
                        return;
                    }

                    if (!response.ok) {
                        const errorMsg = data.error || `Server error: ${response.status}`;
                        console.error('Server error:', data);
                        addMessage(`Error: ${errorMsg}`, 'bot');
                        return;
                    }

                    addMessage(data.response || 'No response from server', 'bot');

                } catch (error) {
                    console.error('Fetch error:', error);
                    hideLoadingIndicator();
                    addMessage(`Error: ${error.message}. Check console for details.`, 'bot');
                }
            }
        });
    });
</script>
{% endblock %}

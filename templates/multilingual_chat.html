{% extends "base.html" %}
{% block title %}KrishiSahyog Chat{% endblock %}

{% block content %}
<div class="row justify-content-center" style="margin-top: 2rem;">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm" style="border: 1px solid var(--bs-border-color); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem; background-color: var(--bs-card-bg);">
      
      <div class="card-header text-white text-center" style="background-color: #198754; color: #fff; text-align: center; border-bottom: 1px solid var(--bs-border-color); font-weight: 500; padding: 0.75rem 1.25rem;">
        <h5 class="mb-0">
           <i class="bi bi-translate"></i> Multilingual Chat
        </h5>
        <small style="opacity: 0.75;">Your Multilingual Farming Assistant</small>
      </div>

      <div class="card-body p-0">
        <div id="chat-box" aria-live="polite" style="height: 60vh; overflow-y: auto; padding: 1rem; background: var(--bs-body-bg); border-bottom: 1px solid var(--bs-border-color);">
          
          <div class="chat-message bot-message" style="padding: 0.6rem 1rem; border-radius: 1rem; max-width: 80%; margin: 0.5rem 0; line-height: 1.5; box-shadow: 0 2px 6px rgba(0,0,0,0.06); position: relative; background: var(--bs-tertiary-bg); color: var(--bs-body-color); margin-right: auto; border-bottom-left-radius: 0.25rem;">
            Hello! I'm KrishiSahyog. Ask me any questions about farming in any Indian language.
          </div>
        </div>
      </div>

      <div class="card-footer" style="background-color: var(--bs-card-bg); border-top: none; padding: 1rem;">
        <form class="chat-input" id="chat-form" autocomplete="off" style="display: flex; gap: 0.5rem;">
          
          <input type="text" id="message" name="message" class="form-control"
                 placeholder="Type your message in any language..." autocomplete="off" required
                 style="flex-grow: 1; border-radius: 20px; border: 1px solid var(--bs-border-color); background-color: var(--bs-body-bg); color: var(--bs-body-color);">
          
          <button type="submit" class="btn btn-success d-flex align-items-center justify-content-center px-3"
                  aria-label="Send" style="border-radius: 50%; width: 44px; height: 44px;">
            <i class="bi bi-send-fill"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('message');

        const addMessage = (message, sender) => {
            const messageElement = document.createElement('div');
            
            // Common styles
            messageElement.style.padding = '0.6rem 1rem';
            messageElement.style.borderRadius = '1rem';
            messageElement.style.maxWidth = '80%';
            messageElement.style.margin = '0.5rem 0';
            messageElement.style.lineHeight = '1.5';
            messageElement.style.boxShadow = '0 2px 6px rgba(0,0,0,0.06)';
            messageElement.style.wordWrap = 'break-word';

            if (sender === 'user') {
                // User message style (theme-independent)
                messageElement.style.background = '#0d6efd'; 
                messageElement.style.color = 'white';
                messageElement.style.marginLeft = 'auto';
                messageElement.style.borderBottomRightRadius = '0.25rem';
            } else {
                // Bot message style (THEME-AWARE using CSS variables)
                messageElement.style.background = 'var(--bs-tertiary-bg)';
                messageElement.style.color = 'var(--bs-body-color)';
                messageElement.style.marginRight = 'auto';
                messageElement.style.borderBottomLeftRadius = '0.25rem';
            }

            messageElement.textContent = message;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        const showTypingIndicator = () => {
            const typingElement = document.createElement('div');
            typingElement.id = 'typing-indicator';
            
            // --- Style it like a bot message (THEME-AWARE) ---
            typingElement.style.padding = '0.6rem 1rem';
            typingElement.style.borderRadius = '1rem';
            typingElement.style.maxWidth = '80%';
            typingElement.style.margin = '0.5rem 0';
            typingElement.style.background = 'var(--bs-tertiary-bg)';
            typingElement.style.color = 'var(--bs-secondary-color)';
            typingElement.style.marginRight = 'auto';
            typingElement.style.borderBottomLeftRadius = '0.25rem';
            typingElement.style.fontStyle = 'italic';
            typingElement.textContent = 'KrishiSahyog is typing...';
            
            chatBox.appendChild(typingElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const hideTypingIndicator = () => {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = userInput.value.trim();

            if (userMessage) {
                addMessage(userMessage, 'user');
                userInput.value = '';
                showTypingIndicator();

                try {
                    const formData = new FormData();
                    formData.append('message', userMessage);
                    
                    const response = await fetch('/multilingual_chat', {
                        method: 'POST',
                        body: formData,
                    });

                    hideTypingIndicator();
                    const responseText = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(responseText);
                    } catch (err) {
                        console.error('Failed to parse JSON:', responseText);
                        addMessage('Server returned an invalid response. Please try again.', 'bot');
                        return;
                    }

                    if (!response.ok) {
                        const errorMsg = data.error || `Server error: ${response.status}`;
                        addMessage(`Error: ${errorMsg}`, 'bot');
                        return;
                    }

                    addMessage(data.response || 'No response from the server.', 'bot');

                } catch (error) {
                    console.error('Fetch error:', error);
                    hideTypingIndicator();
                    addMessage(`Error: ${error.message}. Could not connect to the server.`, 'bot');
                }
            }
        });
    });
</script>
{% endblock %}